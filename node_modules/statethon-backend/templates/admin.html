<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Admin Dashboard - AI-Enhanced Survey</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
	<style>
		:root{ --bg:#f5f7fb; --card:#ffffff; --text:#0f172a; --accent:#2563eb; }
		@keyframes gradientShift {0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
		@keyframes fadeUp {from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
		body { background: linear-gradient(135deg, #eef2ff, #f5f7fb); background-size:200% 200%; animation: gradientShift 18s ease infinite; color: var(--text); }
		/* Dark/Light toggle removed */
		.navbar { background: #ffffff; border-bottom: 1px solid #e5e7eb; }
		.brand { color: var(--text); font-weight: 700; }
		.card { border: 1px solid #e5e7eb; border-radius: 14px; background: var(--card); color: var(--text); box-shadow: 0 6px 18px rgba(0,0,0,.06); opacity:0; animation: fadeUp .5s ease both; }
		.kpi { display:flex; align-items:center; gap:12px; }
		.kpi .icon { width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:10px; background:#eef2ff; color:#2563eb; }
		a { color:#2563eb; }
		a:hover { color:#1e40af; }
		.table thead th { color:#6b7280; }
		.badge-pill { border-radius: 30px; }
	</style>
</head>
<body>
	<nav class="navbar navbar-expand-lg shadow-sm mb-4">
		<div class="container">
			<a class="navbar-brand brand" href="/"><i class="fas fa-chart-line me-2"></i>Admin</a>
			<div class="ms-auto d-flex align-items-center">
				{% if current_user.is_authenticated %}
					{% if current_user.profile_image %}
						<img src="{{ current_user.profile_image }}" class="rounded-circle me-2" style="width:28px;height:28px;object-fit:cover;" alt="avatar"/>
					{% endif %}
					<span class="badge bg-light text-dark me-2"><i class="fas fa-user me-1"></i>{{ current_user.username }}</span>
				{% endif %}
				<a class="btn btn-outline-secondary btn-sm me-2" href="/">Back</a>
				<a class="btn btn-warning btn-sm" href="/logout">Logout</a>
			</div>
		</div>
	</nav>

	<div class="container">
		<div class="row g-3">
			<div class="col-md-3">
				<div class="card p-3 kpi">
					<div class="icon"><i class="fas fa-users"></i></div>
					<div>
						<div class="text-muted">Users</div>
						<div class="h4 mb-0">{{ users }}</div>
					</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card p-3 kpi">
					<div class="icon"><i class="fas fa-database"></i></div>
					<div>
						<div class="text-muted">Datasets</div>
						<div class="h4 mb-0">{{ datasets }}</div>
					</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card p-3 kpi">
					<div class="icon"><i class="fas fa-cog"></i></div>
					<div>
						<div class="text-muted">Runs</div>
						<div class="h4 mb-0">{{ runs }}</div>
					</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card p-3 kpi">
					<div class="icon"><i class="fas fa-file-pdf"></i></div>
					<div>
						<div class="text-muted">Reports</div>
						<div class="h4 mb-0">{{ reports }}</div>
					</div>
				</div>
			</div>
		</div>

		<div class="row g-3 mt-1">
			<div class="col-lg-6">
				<div class="card p-3">
					<h5 class="mb-3">Latest uploads</h5>
					<div class="table-responsive">
						<table class="table table-striped table-hover align-middle">
							<thead>
								<tr>
									<th>File</th><th>Rows</th><th>Cols</th><th>Owner</th><th>Uploaded</th>
								</tr>
							</thead>
							<tbody>
								{% for d in latest %}
								<tr>
									<td>{{ d.filename }}</td>
									<td>{{ d.rows }}</td>
									<td>{{ d.columns }}</td>
									<td>
										{% if d.owner and d.owner.profile_image %}
											<img src="{{ d.owner.profile_image }}" class="rounded-circle me-1" style="width:24px;height:24px;object-fit:cover;" alt="avatar"/>
										{% else %}
											<span class="text-muted">—</span>
										{% endif %}
									</td>
									<td><span class="badge bg-light text-dark badge-pill">{{ d.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</span></td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			</div>
			<div class="col-lg-6">
				<div class="card p-3">
					<div class="d-flex justify-content-between align-items-center mb-3">
						<h5 class="mb-0">Recent runs</h5>
						<input id="runFilter" class="form-control form-control-sm" style="max-width:220px" placeholder="Filter by dataset" oninput="filterRuns()"/>
					</div>
					<div class="table-responsive">
						<table class="table table-striped table-hover align-middle" id="runsTable">
							<thead>
								<tr>
									<th>Dataset</th><th>User</th><th>Success</th><th>Plots</th><th>Time</th>
								</tr>
							</thead>
							<tbody>
								{% for r in recent_runs %}
								<tr>
									<td>{{ r.dataset.filename if r.dataset else '—' }}</td>
									<td>
										{% if r.user and r.user.profile_image %}
											<img src="{{ r.user.profile_image }}" class="rounded-circle me-1" style="width:24px;height:24px;object-fit:cover;" alt="avatar"/>
										{% else %}
											<span class="text-muted">—</span>
										{% endif %}
									</td>
									<td>
										<span class="badge {{ 'bg-success' if r.success else 'bg-danger' }}">{{ 'ok' if r.success else 'fail' }}</span>
									</td>
									<td>{{ r.plots_count }}</td>
									<td><span class="badge bg-light text-dark badge-pill">{{ r.created_at.strftime('%Y-%m-%d %H:%M') }}</span></td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

		<div class="card p-3 mt-3">
			<h5 class="mb-2">User management</h5>
			<div class="table-responsive">
				<table class="table table-striped table-hover align-middle">
					<thead>
						<tr><th>Username</th><th>Email</th><th>Role</th><th>Action</th></tr>
					</thead>
					<tbody>
						{% for u in all_users %}
						<tr>
							<td>{{ u.username }}</td>
							<td>{{ u.email or '—' }}</td>
							<td><span class="badge {{ 'bg-warning text-dark' if u.role=='admin' else 'bg-secondary' }}">{{ u.role }}</span></td>
							<td>
								<form method="POST" action="/admin/user/{{ u.id }}/role" class="d-flex gap-2">
									<select name="role" class="form-select form-select-sm" style="max-width:140px">
										<option value="user" {{ 'selected' if u.role=='user' else '' }}>user</option>
										<option value="admin" {{ 'selected' if u.role=='admin' else '' }}>admin</option>
									</select>
									<button class="btn btn-sm btn-primary">Update</button>
								</form>
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	</div>
</body>
</html>

<script>
function filterRuns(){
    const input = document.getElementById('runFilter');
    if(!input) return;
    const term = input.value.toLowerCase();
    const table = document.getElementById('runsTable');
    if(!table) return;
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const datasetCell = row.querySelector('td');
        const text = (datasetCell ? datasetCell.textContent : '').toLowerCase();
        row.style.display = text.includes(term) ? '' : 'none';
    });
}
</script>


